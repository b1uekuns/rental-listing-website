<%- include('../partials/header') %>

<main>
  <div class="listing-detail-container">
    <% if (locals.error) { %>
    <div class="alert alert-danger"><%= locals.error %></div>
    <% } else if (locals.success) { %>
    <div class="alert alert-success"><%= locals.success %></div>
    <% } %>
    <div class="listing-detail-card">
      <!-- Header v·ªõi ti√™u ƒë·ªÅ v√† ƒë·ªãa ch·ªâ -->
      <div class="listing-header">
        <div class="header-top">
          <div class="header-content">
            <h1 class="listing-title"><%= listing.title %></h1>
          </div>
          <div class="header-actions">
            <% if (user) { %>
            <form
              id="saveListingForm"
              action="/listings/<%= listing.id %>/save"
              method="POST"
              style="display: inline"
            >
              <button type="submit" class="btn-save">üíæ L∆∞u tin</button>
            </form>
            <% } else { %>
            <a href="/auth/login" class="btn-save">üîê ƒêƒÉng nh·∫≠p ƒë·ªÉ l∆∞u tin</a>
            <% } %>
          </div>
        </div>
      </div>

      <!-- Main content v·ªõi h√¨nh ·∫£nh v√† th√¥ng tin -->
      <div class="listing-main-content">
        <div class="listing-images">
          <% if (listing.images_urls && listing.images_urls.length > 0) { %>
          <div
            class="images-grid images-count-<%= listing.images_urls.length %>"
          >
            <% listing.images_urls.forEach((url, index) => { %>
            <img
              src="<%= url %>"
              alt="·∫¢nh tin ƒëƒÉng <%= index + 1 %>"
              class="listing-image image-<%= index + 1 %>"
            />
            <% }) %>
          </div>
          <% } else { %>
          <div class="images-grid images-count-0">
            <img
              src="/images/no-image.png"
              alt="No image"
              class="listing-image"
            />
          </div>
          <% } %>
        </div>

        <!-- Th√¥ng tin ch√≠nh theo style admin -->
        <div class="listing-info">
          <div class="info-grid">
            <div class="info-item price-item">
              <span class="label">GI√Å THU√ä:</span>
              <span class="value"
                ><%= Math.round(listing.price).toLocaleString('vi-VN') %>
                VNƒê/th√°ng</span
              >
            </div>

            <div class="info-item">
              <span class="label">DI·ªÜN T√çCH:</span>
              <span class="value"><%= listing.area %> m¬≤</span>
            </div>

            <div class="info-item">
              <span class="label">LO·∫†I H√åNH:</span>
              <span class="value">
                <% if (listing.property_type === 'phong_tro') { %>Ph√≤ng tr·ªç <% }
                else if (listing.property_type === 'nha_nguyen_can') { %>Nh√†
                nguy√™n cƒÉn <% } else if (listing.property_type === 'can_ho') {
                %>CƒÉn h·ªô <% } else if (listing.property_type === 'o_ghep') { %>·ªû
                gh√©p <% } else { %><%= listing.property_type %><% } %>
              </span>
            </div>

            <div class="info-item">
              <span class="label">ƒê·ªäA CH·ªà:</span>
              <span class="value"><%= listing.address %></span>
            </div>

            <div class="info-item">
              <span class="label">L∆Ø·ª¢T XEM:</span>
              <span class="value"><%= listing.view_count || 0 %></span>
            </div>

            <div class="info-item">
              <span class="label">NG∆Ø·ªúI ƒêƒÇNG:</span>
              <span class="value">
                <%= listing.owner_name %> -
                <a href="tel:<%= listing.phone_number %>" class="phone-link">
                  <%= listing.phone_number %>
                </a>
              </span>
            </div>

            <div class="info-item">
              <span class="label">NG√ÄY ƒêƒÇNG:</span>
              <span class="value"
                ><%= new Date(listing.created_at).toLocaleDateString('vi-VN')
                %></span
              >
            </div>
          </div>
        </div>

        <!-- M√¥ t·∫£ chi ti·∫øt theo style admin -->
        <div class="listing-description">
          <h3>M√¥ t·∫£ chi ti·∫øt</h3>
          <div class="description-content">
            <% if (listing.description && listing.description.trim() !== '') {
            %> <%= listing.description %> <% } else { %>
            <em style="color: var(--gray-400)">Ch∆∞a c√≥ m√¥ t·∫£ chi ti·∫øt.</em>
            <% } %>
          </div>
        </div>
      </div>
    </div>

    <!-- ƒê√°nh gi√° v√† b√¨nh lu·∫≠n -->
    <div class="comments-section" style="margin-top: 2rem">
      <h3>B√¨nh lu·∫≠n & ƒê√°nh gi√°</h3>
      <% if (user) { %>
      <form id="commentForm" class="comment-form">
        <input type="hidden" name="listing_id" value="<%= listing.id %>" />
        <div class="form-group">
          <label>N·ªôi dung:</label>
          <textarea
            name="content"
            required
            placeholder="Nh·∫≠p n·ªôi dung b√¨nh lu·∫≠n"
          ></textarea>
        </div>
        <div class="form-group">
          <label>ƒê√°nh gi√°:</label>
          <select name="rating" required>
            <option value="">Ch·ªçn ƒëi·ªÉm ƒë√°nh gi√°</option>
            <% for(let i=5;i>=1;i--){ %>
            <option value="<%= i %>"><%= i %> ‚≠ê</option>
            <% } %>
          </select>
        </div>
        <button type="submit">G·ª≠i b√¨nh lu·∫≠n</button>
        <div id="commentError" class="error-message"></div>
      </form>
      <% } else { %>
      <p><a href="/auth/login">ƒêƒÉng nh·∫≠p</a> ƒë·ªÉ b√¨nh lu·∫≠n v√† ƒë√°nh gi√°.</p>
      <% } %> <% if (comments && comments.length > 0) { %>
      <div id="commentsList" class="comments-list">
        <% comments.forEach(c => { %>
        <div class="comment">
          <div class="comment-header">
            <img
              src="<%= c.avatar_url || '/images/default-avatar.png' %>"
              alt="avatar"
              class="comment-avatar"
            />
            <div class="comment-info">
              <h4><%= c.full_name %> (<%= c.email %>)</h4>
              <div class="rating"><%= c.rating %> ‚≠ê</div>
            </div>
          </div>
          <p class="comment-content"><%= c.content %></p>
          <small class="comment-date"
            ><%= new Date(c.created_at).toLocaleDateString('vi-VN') %></small
          >
        </div>
        <% }) %>
      </div>
      <% } else { %>
      <p>Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o.</p>
      <% } %>
    </div>
  </div>
</main>

<!-- Script x·ª≠ l√Ω b√¨nh lu·∫≠n AJAX -->
<script>
  // Sync v·ªõi backend - listingController.js
  const BAD_WORDS = [
    "x·∫•u",
    "b·∫≠y",
    "ƒë·ªÉu",
    "ngu",
    "dm",
    "ƒëm",
    "cc",
    "fuck",
    "shit",
  ];

  const commentForm = document.getElementById("commentForm");
  if (commentForm) {
    commentForm.addEventListener("submit", async function (e) {
      e.preventDefault();
      const form = e.target;
      const content = form.content.value.toLowerCase();
      const errorDiv = document.getElementById("commentError");

      // Ki·ªÉm tra t·ª´ x·∫•u
      const found = BAD_WORDS.find((w) => content.includes(w));
      if (found) {
        errorDiv.innerText = "N·ªôi dung ch·ª©a t·ª´ kh√¥ng ph√π h·ª£p!";
        return;
      }

      errorDiv.innerText = "";

      try {
        const data = {
          listing_id: form.listing_id.value,
          content: form.content.value,
          rating: form.rating.value,
        };

        const res = await fetch("/listings/comment", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });

        const result = await res.json();

        if (result.success) {
          // T√¨m ho·∫∑c t·∫°o container cho comments
          let commentsList = document.getElementById("commentsList");
          if (!commentsList) {
            // T·∫°o container m·ªõi n·∫øu ch∆∞a c√≥ comments
            commentsList = document.createElement("div");
            commentsList.id = "commentsList";
            commentsList.className = "comments-list";

            // T√¨m v·ªã tr√≠ ƒë·ªÉ ch√®n (sau form comment)
            const commentsSection = document.querySelector(".comments-section");
            commentsSection.appendChild(commentsList);

            // X√≥a text "Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o" n·∫øu c√≥
            const noCommentsText = commentsSection.querySelector("p");
            if (noCommentsText && noCommentsText.textContent.includes("Ch∆∞a c√≥ b√¨nh lu·∫≠n")) {
              noCommentsText.remove();
            }
          }

          // Th√™m b√¨nh lu·∫≠n m·ªõi v√†o ƒë·∫ßu danh s√°ch
          const commentDiv = document.createElement("div");
          commentDiv.className = "comment";
          commentDiv.innerHTML = `
        <div class="comment-header">
          <img src="${
            result.comment.avatar_url || "/images/default-avatar.png"
          }" alt="avatar" class="comment-avatar">
          <div class="comment-info">
            <h4>${result.comment.full_name} (${result.comment.email})</h4>
            <div class="rating">${result.comment.rating} ‚≠ê</div>
          </div>
        </div>
        <p class="comment-content">${result.comment.content}</p>
        <small class="comment-date">${new Date(
          result.comment.created_at
        ).toLocaleDateString("vi-VN")}</small>
      `;

          commentsList.prepend(commentDiv);
          form.content.value = "";
          form.rating.value = "";
        } else {
          errorDiv.innerText = result.error || "C√≥ l·ªói x·∫£y ra!";
        }
      } catch (error) {
        errorDiv.innerText = "C√≥ l·ªói khi g·ª≠i b√¨nh lu·∫≠n!";
      }
    });
  }

  if (document.getElementById("saveListingForm")) {
    document
      .getElementById("saveListingForm")
      .addEventListener("submit", async function (e) {
        e.preventDefault();
        const btn = this.querySelector('button[type="submit"]');
        btn.disabled = true;

        try {
          const res = await fetch(this.action, {
            method: "POST",
            headers: { "X-Requested-With": "XMLHttpRequest" },
          });
          const data = await res.json();

          // T·∫°o th√¥ng b√°o ·ªü ƒë·∫ßu trang (gi·ªëng nh∆∞ c√°c th√¥ng b√°o kh√°c)
          const container = document.querySelector(".listing-detail-container");
          const existingAlert = container.querySelector(".alert");
          if (existingAlert) {
            existingAlert.remove();
          }

          const alertDiv = document.createElement("div");
          if (data.success) {
            alertDiv.className = "alert alert-success";
            alertDiv.textContent = data.message;
          } else {
            alertDiv.className = "alert alert-danger";
            alertDiv.textContent = data.message;
          }

          // Ch√®n th√¥ng b√°o v√†o ƒë·∫ßu container
          container.insertBefore(alertDiv, container.firstChild);

          // T·ª± ƒë·ªông ·∫©n sau 5 gi√¢y
          setTimeout(() => {
            if (alertDiv.parentNode) {
              alertDiv.style.transition =
                "opacity 0.5s ease-out, transform 0.5s ease-out";
              alertDiv.style.opacity = "0";
              alertDiv.style.transform = "translateY(-20px)";
              setTimeout(() => {
                if (alertDiv.parentNode) {
                  alertDiv.remove();
                }
              }, 500);
            }
          }, 5000);
        } catch (error) {
          console.error("Error saving listing:", error);
          const container = document.querySelector(".listing-detail-container");
          const alertDiv = document.createElement("div");
          alertDiv.className = "alert alert-danger";
          alertDiv.textContent = "C√≥ l·ªói khi l∆∞u tin!";
          container.insertBefore(alertDiv, container.firstChild);
        }
        btn.disabled = false;
      });
  }
</script>

<%- include('../partials/footer') %>
